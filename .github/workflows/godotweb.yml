name: Godot Export and Deploy to Web Branch

on: 
  push:
    branches:
      - main

jobs:
  export_game:
    runs-on: ubuntu-latest
    permissions: write-all
    name: Export Game

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
  
    - name: Create build directory
      run: mkdir -p build/web

    - name: Export game
      id: export
      uses: firebelley/godot-export@v6.0.0
      with:
        godot_executable_download_url: https://github.com/godotengine/godot/releases/download/4.3-stable/Godot_v4.3-stable_linux.x86_64.zip
        godot_export_templates_download_url: https://github.com/godotengine/godot-builds/releases/download/4.3-stable/Godot_v4.3-stable_export_templates.tpz
        relative_project_path: ./
        archive_output: true

    - name: List directory contents (debug)
      run: ls -R

    - name: Deploy to web branch
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git checkout -b web
        ls build/  # Check if the build directory exists and has contents
        git add -f build/
        git commit -m "Automated web export"
        git push -f origin web
