name: Godot Export and Deploy to Web Branch

on: 
  push:
    branches:
      - main

jobs:
  export_game:
    runs-on: ubuntu-latest
    permissions: write-all
    name: Export Game

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Create build directory
      run: mkdir -p build/web

    - name: Export game
      id: export
      uses: firebelley/godot-export@v6.0.0
      with:
        godot_executable_download_url: https://github.com/godotengine/godot/releases/download/4.3-stable/Godot_v4.3-stable_linux.x86_64.zip
        godot_export_templates_download_url: https://github.com/godotengine/godot-builds/releases/download/4.3-stable/Godot_v4.3-stable_export_templates.tpz
        relative_project_path: ./
        archive_output: false
        export_debug: false
        export_preset_name: "Web"
        export_path: "build/web"

    # Debug steps to understand what's happening
    - name: Debug Export
      run: |
        echo "Project structure:"
        ls -R
        
        echo "\nExport preset contents:"
        cat export_presets.cfg
        
        echo "\nBuild directory contents:"
        ls -la build/web/ || echo "build/web/ does not exist"
        
        echo "\nGodot exported directory contents:"
        ls -la .godot/exported/ || echo ".godot/exported/ does not exist"

    - name: Deploy to web branch
      if: success()
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # Create and switch to an orphan web branch
        git checkout --orphan web
        git reset --hard
        
        if [ -d "build/web" ]; then
          # Copy web files to root
          cp -r build/web/* .
          
          # Clean up
          rm -rf build
          
          # Add and commit
          git add -A
          git commit -m "Deploy web build"
          git push -f origin web
        else
          echo "No web build found in build/web/"
          exit 1
        fi
